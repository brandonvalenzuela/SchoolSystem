@using SchoolSystem.Web.Models
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Detectamos calificaciones existentes</MudText>

            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                Se encontraron alumnos que ya tenían calificación en este <b>grupo / materia / periodo</b>.
                Elige qué deseas hacer.
            </MudAlert>

            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Enviadas</MudText>
                        <MudText Typo="Typo.h5">@Model.TotalEnviadas</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Nuevas</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Success">@Nuevas</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Ya tenían</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Warning">@Model.Existentes.Count</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudDivider />

            <MudSwitch T="bool"
                       @bind-Checked="_recalificar"
                       Color="Color.Primary"
                       Disabled="@(!_permiteRecalificar)"
                       Label="Recalificar a los alumnos que ya tenían calificación" />

            @if (!_permiteRecalificar)
            {
                <MudText Typo="Typo.body2" Color="Color.Error">
                    No es posible recalificar: @Model.MotivoNoPermiteRecalificar
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Si activas esta opción, se actualizarán @Model.Existentes.Count alumno(s) que ya tenían calificaciones.
                </MudText>
            }

            <!-- AUDITORÍA: Campo de motivo de recalificación -->
            @if (_recalificar && _permiteRecalificar)
            {
                <MudPaper Class="pa-3 my-3 bg-info-light">
                    <MudText Typo="Typo.caption" Color="Color.Info">
                        <strong>ℹ️ Resumen:</strong> Se recalificarán <strong>@Model.Existentes.Count</strong> alumno(s)
                    </MudText>
                </MudPaper>

                @if (_mostrarErrorMotivo)
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Error" Class="mb-3">
                        <MudText Typo="Typo.body2">
                            <strong>❌ Motivo requerido:</strong> Debes indicar un motivo para recalificar (mínimo 10 caracteres).
                        </MudText>
                    </MudAlert>
                }

                <MudTextField T="string"
                              @bind-Value="_motivoRecalificacion"
                              Label="Motivo de recalificación (obligatorio)"
                              Placeholder="Ej: Corrección por error de captura, ajuste por evaluación extraordinaria…"
                              Lines="3"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Counter="500"
                              MaxLength="500"
                              Required="true"
                              RequiredError="El motivo es obligatorio"
                              HelperText="Proporciona un motivo claro (mín. 10 caracteres). Se registrará en auditoría."
                              CharacterCounter="true" />
            }

            <MudDivider />

            <MudText Typo="Typo.subtitle1">Alumnos con calificación existente</MudText>

            <MudTable Items="Model.Existentes" Dense="true" Hover="true" Bordered="true">
                <HeaderContent>
                    <MudTh>AlumnoId</MudTh>
                    <MudTh>Calificación actual</MudTh>
                    <MudTh>Observaciones actuales</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="AlumnoId">@context.AlumnoId</MudTd>
                    <MudTd DataLabel="Calificación">@context.CalificacionActual</MudTd>
                    <MudTd DataLabel="Obs">@context.ObservacionesActuales</MudTd>
                </RowTemplate>
            </MudTable>

            @if (Model.Errores != null && Model.Errores.Count > 0)
            {
                <MudDivider />

                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">
                            <b>⚠️ Alumnos que serán omitidos:</b> Los siguientes alumnos se omitirán aunque actives la opción de recalificar.
                            Revisa los motivos y considera contactar al administrador si hay algún problema.
                        </MudText>
                    </MudStack>
                </MudAlert>

                <MudTable Items="Model.Errores" Dense="true" Hover="true" Bordered="true">
                    <HeaderContent>
                        <MudTh>AlumnoId</MudTh>
                        <MudTh>Motivo de omisión</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="AlumnoId">@context.AlumnoId</MudTd>
                        <MudTd DataLabel="Motivo">@context.Motivo</MudTd>
                    </RowTemplate>
                </MudTable>
            }

            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                Si eliges "Guardar solo nuevas", los alumnos ya calificados se omitirán sin cambios.
            </MudAlert>
        </MudStack>
    </DialogContent>

        <DialogActions>
            <MudButton Variant="Variant.Text" OnClick="Cancelar">Cancelar</MudButton>

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="GuardarSoloNuevas">
                Guardar solo nuevas
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@(!PuedeRecalificar())"
                       OnClick="RecalificarYGuardar">
                Recalificar + Guardar
            </MudButton>
        </DialogActions>
    </MudDialog>

    @code {
        [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
        [Parameter] public CalificacionMasivaResultadoDto Model { get; set; } = new();

        private bool _recalificar;
        private string? _motivoRecalificacion;
        private bool _mostrarErrorMotivo;

        private bool _permiteRecalificar => Model?.PermiteRecalificar ?? false;
        private int Nuevas => (Model?.TotalEnviadas ?? 0) - (Model?.Existentes?.Count ?? 0);

        private void Cancelar() => MudDialog.Cancel();

        private void GuardarSoloNuevas()
            => MudDialog.Close(DialogResult.Ok(new RecalificarDecision 
            { 
                PermitirRecalificarExistentes = false,
                MotivoRecalificacion = null
            }));

        /// <summary>
        /// Valida si el usuario puede recalificar:
        /// - Debe haber seleccionado recalificar
        /// - Debe haber indicado un motivo válido (mínimo 10 caracteres)
        /// </summary>
        private bool PuedeRecalificar()
        {
            if (!_permiteRecalificar)
                return false;

            if (!_recalificar)
                return true; // Si no está marcado recalificar, permite otros botones

            // Si está marcado recalificar, el motivo es obligatorio y debe tener mínimo 10 caracteres
            return !string.IsNullOrWhiteSpace(_motivoRecalificacion) && _motivoRecalificacion.Length >= 10;
        }

        private void RecalificarYGuardar()
        {
            _mostrarErrorMotivo = false;

            // Validación: Si intenta recalificar sin motivo o con motivo muy corto
            if (_recalificar && (string.IsNullOrWhiteSpace(_motivoRecalificacion) || _motivoRecalificacion.Length < 10))
            {
                _mostrarErrorMotivo = true;
                return;
            }

            MudDialog.Close(DialogResult.Ok(new RecalificarDecision 
            { 
                PermitirRecalificarExistentes = _recalificar,
                MotivoRecalificacion = _recalificar ? _motivoRecalificacion?.Trim() : null
            }));
        }
    }
