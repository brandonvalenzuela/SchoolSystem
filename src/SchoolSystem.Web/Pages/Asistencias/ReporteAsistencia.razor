@page "/asistencias/reporte"
@using SchoolSystem.Web.Models
@using SchoolSystem.Web.Services
@inject AsistenciaService AsistenciaService
@inject GrupoService GrupoService
@attribute [Authorize(Roles = "Maestro,Director,SuperAdmin")]

<PageTitle>Reporte de Asistencia</PageTitle>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="oi oi-spreadsheet"></i> Reporte Mensual de Asistencia</h2>
    </div>

    <!-- FILTROS -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Grupo</label>
                    <select class="form-select" @bind="grupoId">
                        <option value="0">-- Seleccione --</option>
                        @foreach (var g in grupos)
                        {
                            <option value="@g.Id">@g.NombreCompleto</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Mes</label>
                    <select class="form-select" @bind="mes">
                        @for (int i = 1; i <= 12; i++)
                        {
                            <option value="@i">@System.Globalization.DateTimeFormatInfo.CurrentInfo.GetMonthName(i)</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Año</label>
                    <input type="number" class="form-control" @bind="anio" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" @onclick="GenerarReporte" disabled="@(grupoId == 0 || isLoading)">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {

                            <span>Generar</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA REPORTE -->
    @if (reporte != null && reporte.Any())
    {
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 text-center table-sm" style="font-size: 0.9rem;">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-start ps-3" style="min-width: 250px;">Alumno</th>
                                <!-- Días del mes (1 al 30/31) -->
                                @foreach (var dia in reporte.First().Dias)
                                {
                                    <th style="width: 30px;">@dia.Dia</th>
                                }
                                <th class="bg-secondary">%</th>
                                <th class="bg-danger">F</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in reporte)
                            {
                                <tr>
                                    <td class="text-start ps-3 fw-bold">@row.NombreAlumno</td>
                                    @foreach (var dia in row.Dias)
                                    {
                                        <td class="@GetClaseCelda(dia.Estatus)">@dia.Estatus</td>
                                    }
                                    <td class="fw-bold">@row.Porcentaje%</td>
                                    <td class="text-danger fw-bold">@row.Faltas</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <small class="text-muted">
                <span class="badge bg-success">P</span> Presente |
                <span class="badge bg-danger">F</span> Falta |
                <span class="badge bg-warning text-dark">R</span> Retardo |
                <span class="badge bg-info text-dark">J</span> Justificado
            </small>
        </div>
    }
    else if (busquedaRealizada)
    {
        <div class="alert alert-warning text-center">No hay datos para el periodo seleccionado.</div>
    }
</div>

@code {
    private List<GrupoDto> grupos = new();
    private List<ReporteMensualDto> reporte;

    private int grupoId;
    private int mes = DateTime.Now.Month;
    private int anio = DateTime.Now.Year;

    private bool isLoading = false;
    private bool busquedaRealizada = false;

    protected override async Task OnInitializedAsync()
    {
        // Cargar grupos (podrías usar GetMisGruposAsync si quieres restringirlo)
        var res = await GrupoService.GetGruposAsync(1, 100);
        if (res.Succeeded)
            grupos = res.Data.Items.ToList();
    }

    private async Task GenerarReporte()
    {
        isLoading = true;
        busquedaRealizada = false;
        reporte = null;

        try
        {
            var res = await AsistenciaService.GetReporteMensualAsync(grupoId, mes, anio);
            if (res.Succeeded)
            {
                reporte = res.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
            busquedaRealizada = true;
        }
    }

    private string GetClaseCelda(string estatus) => estatus switch
    {
        "P" => "table-success",    // Verde claro
        "F" => "table-danger",     // Rojo claro
        "R" => "table-warning",    // Amarillo
        "J" => "table-info",       // Azul claro
        "S/D" => "bg-light text-muted", // Fin de semana
        _ => ""
    };
}