@page "/usuarios/crear"
@page "/usuarios/editar/{Id:int}"
@using SchoolSystem.Web.Models
@using SchoolSystem.Web.Services
@using SchoolSystem.Web.Services.Toast
@inject UsuarioService UsuarioService
@inject NavigationManager Navigation
@inject ToastService ToastService
@attribute [Authorize]

<div class="container mt-4 mb-5">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">@(Id == 0 ? "Nuevo Usuario Administrativo" : "Editar Usuario")</h4>
            <a href="usuarios" class="btn btn-outline-light btn-sm">Volver</a>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Cargando...</p>
                </div>
            }
            else
            {
                <EditForm Model="@modelo" OnValidSubmit="Guardar">
                    <DataAnnotationsValidator />
                    <div class="alert alert-info">
                        <small>Nota: Use este formulario solo para Directores y Administrativos. Para Maestros, Padres o Alumnos vaya a sus módulos respectivos.</small>
                    </div>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nombre</label>
                            <InputText class="form-control" @bind-Value="modelo.Nombre" />
                            <ValidationMessage For="@(() => modelo.Nombre)" />
                        </div>
                        <div class="col-md-6">
                            <label>Apellido Paterno</label>
                            <InputText class="form-control" @bind-Value="modelo.ApellidoPaterno" />
                            <ValidationMessage For="@(() => modelo.ApellidoPaterno)" />
                        </div>
                        <div class="col-md-6">
                            <label>Apellido Materno</label>
                            <InputText class="form-control" @bind-Value="modelo.ApellidoMaterno" />
                        </div>
                        <div class="col-md-6">
                            <label>Rol</label>
                            <!-- Solo permitimos roles administrativos aquí -->
                            <InputSelect class="form-select" @bind-Value="modelo.Rol">
                                <option value="">-- Seleccione Rol --</option>
                                <option value="1">Super Admin</option>
                                <option value="2">Director</option>
                                <option value="3">Subdirector</option>
                                <option value="4">Administrativo</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => modelo.Rol)" />
                        </div>
                        <div class="col-md-6">
                            <label>Email</label>
                            <InputText class="form-control" @bind-Value="modelo.Email" />
                            <ValidationMessage For="@(() => modelo.Email)" />
                        </div>
                        <div class="col-md-6">
                            <label>Username</label>
                            <InputText class="form-control" @bind-Value="modelo.Username" />
                            <ValidationMessage For="@(() => modelo.Username)" />
                        </div>
                        @if (Id == 0)
                        {
                            <div class="col-md-6">
                                <label>Contraseña</label>
                                <InputText type="password" class="form-control" @bind-Value="modelo.Password" />
                                <ValidationMessage For="@(() => modelo.Password)" />
                            </div>
                        }
                    </div>

                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-success" disabled="@isSubmitting">Guardar</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private CreateUsuarioDto modelo = new CreateUsuarioDto { Rol = 4 }; // Default Administrativo
    private bool isLoading = false, isSubmitting = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {
            await CargarUsuarioParaEditar();
        }
    }

    private async Task CargarUsuarioParaEditar()
    {
        isLoading = true;
        var response = await UsuarioService.GetByIdAsync(Id);

        if (response.Succeeded)
        {
            var u = response.Data;
            modelo.Nombre = u.Nombre ?? string.Empty;
            modelo.ApellidoPaterno = u.ApellidoPaterno ?? string.Empty;
            modelo.ApellidoMaterno = u.ApellidoMaterno ?? string.Empty;
            modelo.Email = u.Email ?? string.Empty;
            modelo.Username = u.Username ?? string.Empty;
            modelo.Telefono = u.Telefono ?? string.Empty;

            // MAPEO DE ROL: convertir string "Director" a int (2)
            modelo.Rol = ConvertirRolStringAInt(u.Rol);

            // Placeholder para contraseña en edición (no debe ser visible)
            modelo.Password = "PLACEHOLDER";
        }
        else
        {
            ToastService.ShowError("No se pudo cargar el usuario.");
        }
        isLoading = false;
    }

    /// <summary>
    /// Convierte el string de rol (del DTO) a int (para el modelo del formulario).
    /// </summary>
    private int ConvertirRolStringAInt(string rol)
    {
        return rol?.ToLower() switch
        {
            "superadmin" => 1,
            "director" => 2,
            "subdirector" => 3,
            "administrativo" => 4,
            "maestro" => 5,
            "padre" => 6,
            "alumno" => 7,
            _ => 4 // Default: Administrativo
        };
    }

            private async Task Guardar()
            {
                isSubmitting = true;
                errorMessage = null;

                try
                {
                    if (Id == 0)
                    {
                        // Crear usuario
                        var res = await UsuarioService.CreateAsync(modelo);
                        if (res.Succeeded)
                        { 
                            ToastService.ShowSuccess("¡Usuario creado exitosamente!");
                            Navigation.NavigateTo("usuarios"); 
                        }
                        else
                        {
                            ToastService.ShowError(res.Message ?? "Error al crear usuario.");
                            errorMessage = res.Message;
                        }
                    }
                    else
                    {
                        // Editar usuario - mapear a UpdateUsuarioDto (Web Models)
                        var updateDto = new UpdateUsuarioDto
                        {
                            Id = this.Id,
                            Username = modelo.Username ?? string.Empty,
                            Email = modelo.Email ?? string.Empty,
                            Rol = modelo.Rol, // int
                            Nombre = modelo.Nombre ?? string.Empty,
                            ApellidoPaterno = modelo.ApellidoPaterno ?? string.Empty,
                            ApellidoMaterno = modelo.ApellidoMaterno ?? string.Empty,
                            Telefono = modelo.Telefono ?? string.Empty,
                            Activo = true // Activo por defecto
                        };

                        var res = await UsuarioService.UpdateAsync(Id, updateDto);
                        if (res.Succeeded)
                        {
                            ToastService.ShowSuccess("¡Usuario actualizado exitosamente!");
                            Navigation.NavigateTo("usuarios");
                        }
                        else
                        {
                            ToastService.ShowError(res.Message ?? "Error al actualizar usuario.");
                            errorMessage = res.Message;
                        }
                    }
                }
                catch (Exception ex)
                {
                    errorMessage = ex.Message;
                    ToastService.ShowError($"Error de conexión: {ex.Message}");
                }
                finally
                {
                    isSubmitting = false;
                }
            }
        }
