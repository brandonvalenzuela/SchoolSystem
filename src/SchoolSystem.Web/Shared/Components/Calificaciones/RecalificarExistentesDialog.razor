@using SchoolSystem.Web.Models
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Detectamos calificaciones existentes</MudText>

            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                Se encontraron alumnos que ya tenían calificación en este <b>grupo / materia / periodo</b>.
                Elige qué deseas hacer.
            </MudAlert>

            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Enviadas</MudText>
                        <MudText Typo="Typo.h5">@Model.TotalEnviadas</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Nuevas</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Success">@Nuevas</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-3">
                        <MudText Typo="Typo.caption">Ya tenían</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Warning">@Model.Existentes.Count</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudDivider />

            <MudSwitch T="bool"
                       @bind-Checked="_recalificar"
                       Color="Color.Primary"
                       Disabled="@(!_permiteRecalificar)"
                       Label="Recalificar a los alumnos que ya tenían calificación" />

            @if (!_permiteRecalificar)
            {
                <MudText Typo="Typo.body2" Color="Color.Error">
                    No es posible recalificar: @Model.MotivoNoPermiteRecalificar
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Si activas esta opción, se actualizarán únicamente los alumnos listados como “Ya tenían”.
                </MudText>
            }

            <MudDivider />

            <MudText Typo="Typo.subtitle1">Alumnos con calificación existente</MudText>

            <MudTable Items="Model.Existentes" Dense="true" Hover="true" Bordered="true">
                <HeaderContent>
                    <MudTh>AlumnoId</MudTh>
                    <MudTh>Calificación actual</MudTh>
                    <MudTh>Observaciones actuales</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="AlumnoId">@context.AlumnoId</MudTd>
                    <MudTd DataLabel="Calificación">@context.CalificacionActual</MudTd>
                    <MudTd DataLabel="Obs">@context.ObservacionesActuales</MudTd>
                </RowTemplate>
            </MudTable>

            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                Si eliges “Guardar solo nuevas”, los alumnos ya calificados se omitirán sin cambios.
            </MudAlert>
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancelar">Cancelar</MudButton>

        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="GuardarSoloNuevas">
            Guardar solo nuevas
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Success"
                   Disabled="@(!_permiteRecalificar)"
                   OnClick="RecalificarYGuardar">
            Recalificar + Guardar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public CalificacionMasivaResultadoDto Model { get; set; } = new();

    private bool _recalificar;

    private bool _permiteRecalificar => Model?.PermiteRecalificar ?? false;
    private int Nuevas => (Model?.TotalEnviadas ?? 0) - (Model?.Existentes?.Count ?? 0);

    private void Cancelar() => MudDialog.Cancel();

    private void GuardarSoloNuevas()
        => MudDialog.Close(DialogResult.Ok(new RecalificarDecision { PermitirRecalificarExistentes = false }));

    private void RecalificarYGuardar()
        => MudDialog.Close(DialogResult.Ok(new RecalificarDecision { PermitirRecalificarExistentes = true }));
}
