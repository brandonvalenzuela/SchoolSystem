@page "/"
@using MudBlazor
@using SchoolSystem.Web.Models
@using SchoolSystem.Web.Services
@inject DashboardService DashboardService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<div class="mb-4">
    <MudText Typo="Typo.h5" Class="fw-bold text-dark">School Dashboard</MudText>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center mt-12">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </div>
}
else if (stats != null)
{
    <MudGrid Spacing="4">
        
        <!-- ============================================================== -->
        <!-- COLUMNA 1 (IZQUIERDA - 50% ANCHO)                              -->
        <!-- Contiene: KPIs, Gráfica Principal, Tabla Estudiantes           -->
        <!-- ============================================================== -->
        <MudItem xs="12" lg="6">
            <MudGrid Spacing="3">
                
                <!-- SECCIÓN KPIs (Anidados aquí dentro) -->
                <!-- Fila 1 -->
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Total Students" Value="@stats.TotalAlumnos.ToString()" Icon="@Icons.Material.Filled.School" Color="Color.Primary" 
                                                                TrendValue="+12%"
                                                                TrendLabel="vs mes pasado"
                                                                TrendIcon="@Icons.Material.Filled.TrendingUp"
                                                                TrendColor="Color.Success" />

                </MudItem>
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Total Teachers" Value="@stats.TotalMaestros.ToString()" Icon="@Icons.Material.Filled.Person" Color="Color.Warning" 
                                                                TrendValue="Activos"
                                                                TrendLabel=""
                                                                TrendIcon="@Icons.Material.Filled.CheckCircle"
                                                                TrendColor="Color.Success" />

                </MudItem>
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Total Courses" Value="@stats.TotalGrupos.ToString()" Icon="@Icons.Material.Filled.Book" Color="Color.Info"
                                                                TrendValue="Hoy:"
                                                                TrendLabel="@stats.PagosRealizadosHoy.ToString()"
                                                                TrendIcon="@Icons.Material.Filled.Today"
                                                                TrendColor="Color.Success" />

                </MudItem>

                <!-- Fila 2 -->
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Class Rooms" Value="65" Icon="@Icons.Material.Filled.MeetingRoom" Color="Color.Warning" 
                                                                TrendValue="Cartera"
                                                                TrendLabel="vencida"
                                                                TrendIcon="@Icons.Material.Filled.Warning"
                                                                TrendColor="Color.Error" />

                </MudItem>
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Total Earnings" Value="@($"${(stats.IngresosMesActual / 1000).ToString("0")}M")" Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Secondary" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <SchoolSystem.Web.Shared.Components.KpiCard Title="Awards" Value="30+" Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Success" />
                </MudItem>

                <!-- GRÁFICA DE BARRAS (Total Students) -->
                <!-- PANEL DE GRÁFICAS CON PESTAÑAS (Altura 420px) -->
                <MudItem xs="12">
                    <MudPaper Outlined="true" Class="rounded-lg d-flex flex-column overflow-hidden" Elevation="0" Style="height: 420px;">

                        <!-- Pestañas Transparentes -->
                        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true"
                                 PanelClass="pa-4 h-100" Color="Color.Transparent" SliderColor="Color.Primary"
                                 centered="false">

                            <!-- TAB 1: ALUMNOS (Gráfica de Barras Tricolor) -->
                            <MudTabPanel Text="Población Escolar" Icon="@Icons.Material.Filled.School">
                                <div class="d-flex flex-column h-100">
                                    <div class="d-flex justify-space-between align-center mb-2">
                                        <div>
                                            <MudText Typo="Typo.h6" Class="fw-bold">Movimiento Estudiantil</MudText>
                                            
                                        </div>
                                        <MudText Typo="Typo.caption" Class="text-muted">Histórico de los últimos 5 años</MudText>
                                        <!-- Leyenda -->
                                        <div class="d-flex gap-3">
                                            <div class="d-flex align-center"><div style="width: 10px; height: 10px; background-color: #3B82F6; border-radius: 50%; margin-right: 5px;"></div><span class="small text-muted">Nuevos</span></div>
                                            <div class="d-flex align-center"><div style="width: 10px; height: 10px; background-color: #10B981; border-radius: 50%; margin-right: 5px;"></div><span class="small text-muted">Egresados</span></div>
                                            <div class="d-flex align-center"><div style="width: 10px; height: 10px; background-color: #EF4444; border-radius: 50%; margin-right: 5px;"></div><span class="small text-muted">Bajas</span></div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        @if (stats.StudentsChart != null)
                                        {
                                            <MudChart ChartType="ChartType.Bar"
                                                      ChartSeries="@SeriesStudents"
                                                      XAxisLabels="@LabelsAnios"
                                                      Width="100%" Height="300px"
                                                      ChartOptions="@OptionsAlumnos">
                                            </MudChart>
                                        }
                                    </div>
                                </div>
                            </MudTabPanel>

                            <!-- TAB 2: FINANZAS (Gráfica Stacked) -->
                            <MudTabPanel Text="Finanzas" Icon="@Icons.Material.Filled.AttachMoney">
                                <div class="d-flex flex-column h-100">
                                    <div class="d-flex justify-space-between align-center mb-2">
                                        <div>
                                            <MudText Typo="Typo.h6" Class="fw-bold">Eficiencia de Cobranza</MudText>

                                            <!-- Indicador de Tendencia -->
                                            @if (TendenciaFinanciera != 0)
                                            {
                                                <div class="d-flex align-center mt-1">
                                                    <MudIcon Icon="@(TendenciaFinanciera > 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)"
                                                             Color="@(TendenciaFinanciera > 0 ? Color.Success : Color.Error)" Size="Size.Small" Class="mr-1" />
                                                    <MudText Typo="Typo.caption" Color="@(TendenciaFinanciera > 0 ? Color.Success : Color.Error)" Class="fw-bold">
                                                        @(TendenciaFinanciera > 0 ? "+" : "")@TendenciaFinanciera.ToString("N1")%
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Class="text-muted ml-1">vs mes pasado</MudText>
                                                </div>
                                            }
                                        </div>
                                        <div class="d-flex gap-3">
                                            <div class="d-flex align-center"><div style="width: 10px; height: 10px; background-color: #10B981; border-radius: 50%; margin-right: 5px;"></div><span class="small text-muted">Cobrado</span></div>
                                            <div class="d-flex align-center"><div style="width: 10px; height: 10px; background-color: #E2E8F0; border-radius: 50%; margin-right: 5px;"></div><span class="small text-muted">Pendiente</span></div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        @if (stats.FinanceChart != null)
                                        {
                                            <MudChart ChartType="ChartType.StackedBar"
                                                      ChartSeries="@SeriesFinanzas"
                                                      XAxisLabels="@LabelsMesesFinanzas"
                                                      Width="100%" Height="300px"
                                                      ChartOptions="@OptionsFinanzas">
                                            </MudChart>
                                        }
                                    </div>
                                </div>
                            </MudTabPanel>

                            <!-- TAB 3: ASISTENCIA (Placeholder) -->
                            <MudTabPanel Text="Asistencia" Icon="@Icons.Material.Filled.EventAvailable">
                                <div class="d-flex flex-column h-100 justify-center align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Construction" Size="Size.Large" Color="Color.Warning" />
                                    <MudText Typo="Typo.h6" Class="mt-3">Análisis de Asistencia</MudText>
                                    <MudText Typo="Typo.body2" Class="text-muted">Próximamente disponible</MudText>
                                </div>
                            </MudTabPanel>

                        </MudTabs>
                    </MudPaper>
                </MudItem>

                <!-- TABLA DE ESTUDIANTES (Sigue abajo) -->
                <MudItem xs="12">
                    <MudPaper Outlined="true" Class="rounded-lg overflow-hidden d-flex flex-column" Elevation="0" Style="height: 500px;">
                        <!-- ... Contenido de la tabla ... -->
                        <div class="pa-4 border-b mud-border-lines-default d-flex justify-space-between align-center">
                            <MudText Typo="Typo.h6" Class="fw-bold">New Students</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Color="Color.Default" />
                        </div>
                        <div class="flex-grow-1 overflow-auto">
                            <MudSimpleTable Hover="true" Dense="true" Elevation="0" Style="width: 100%;">
                                <tbody>
                                    @foreach (var st in estudiantesDummy)
                                    {
                                        <tr>
                                            <td style="width: 50px;">
                                                <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Medium">@st.Nombre.Substring(0, 1)</MudAvatar>
                                            </td>
                                            <td>
                                                <MudText Typo="Typo.subtitle2" Class="fw-bold">@st.Nombre</MudText>
                                                <MudText Typo="Typo.caption" Class="text-muted">@st.Matricula</MudText>
                                            </td>
                                            <td><MudText Typo="Typo.body2">@st.Grado</MudText></td>
                                            <td class="text-end">
                                                <MudIconButton Icon="@Icons.Material.Outlined.Edit" Size="Size.Small" />
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>

        <!-- ============================================================== -->
        <!-- COLUMNA 2 (CENTRO - 25% ANCHO)                                 -->
        <!-- Contiene: Gráfica Dona, Lista Tests                            -->
        <!-- ============================================================== -->
        <MudItem xs="12" md="6" lg="3">
            <MudGrid Spacing="3">

                <!-- GRÁFICA DONA (Course Activities) -->
                <!-- AJUSTE: Aumentamos a 300px para igualar las 2 filas de KPIs -->
                <MudItem xs="12">
                    <MudPaper Outlined="true" Class="pa-4 rounded-lg d-flex flex-column" Elevation="0" Style="height: 290px;">
                        <div class="d-flex justify-space-between align-center mb-1">
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">Course Activities</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" />
                        </div>
                        <div class="flex-grow-1 d-flex justify-center align-center">
                            <!-- Aumentamos un poco la gráfica también -->
                            <MudChart ChartType="ChartType.Donut" Width="170px" Height="170px"
                                      InputData="@dataActivities" InputLabels="@labelsActivities"
                                      LegendPosition="Position.Right">
                            </MudChart>
                        </div>
                    </MudPaper>
                </MudItem>

                <!-- LISTA UPCOMING TEST -->
                <!-- Mantenemos 420px para alinearse con la gráfica de barras de la izquierda -->
                <MudItem xs="12">
                    <MudPaper Outlined="true" Class="pa-4 rounded-lg d-flex flex-column" Elevation="0" Style="height: 420px;">
                        <div class="d-flex justify-space-between align-center mb-4">
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">Upcoming Test</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" />
                        </div>

                        <div class="flex-grow-1 overflow-auto d-flex flex-column gap-4 pr-2">
                            <!-- Items de la lista... -->
                            <div class="d-flex align-center gap-3">
                                <MudAvatar Rounded="true" Color="Color.Info" Variant="Variant.Outlined">
                                    <MudIcon Icon="@Icons.Material.Filled.Computer" Size="Size.Small" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body2" Class="fw-bold">Basic Computer</MudText>
                                    <MudText Typo="Typo.caption" Class="text-muted">Class 9</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold">26 Dec</MudText>
                            </div>
                            <MudDivider />
                            <div class="d-flex align-center gap-3">
                                <MudAvatar Rounded="true" Color="Color.Error" Variant="Variant.Outlined">
                                    <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body2" Class="fw-bold">Science Part 2</MudText>
                                    <MudText Typo="Typo.caption" Class="text-muted">Class 11</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold">21 Dec</MudText>
                            </div>
                            <MudDivider />
                            <div class="d-flex align-center gap-3">
                                <MudAvatar Rounded="true" Color="Color.Warning" Variant="Variant.Outlined">
                                    <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Small" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body2" Class="fw-bold">English Grammar</MudText>
                                    <MudText Typo="Typo.caption" Class="text-muted">Class 12</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold">15 Dec</MudText>
                            </div>
                            <MudDivider />
                            <div class="d-flex align-center gap-3">
                                <MudAvatar Rounded="true" Color="Color.Success" Variant="Variant.Outlined">
                                    <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Small" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body2" Class="fw-bold">Mathematics</MudText>
                                    <MudText Typo="Typo.caption" Class="text-muted">Class 10</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold">10 Dec</MudText>
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>

            </MudGrid>
        </MudItem>

        <!-- ============================================================== -->
        <!-- COLUMNA 3 (DERECHA - 25% ANCHO) - PANEL UNIFICADO              -->
        <!-- ============================================================== -->
        <MudItem xs="12" md="6" lg="3">
            <MudPaper Outlined="true" Class="pa-4 rounded-lg h-100" Elevation="0">
                <!-- CALENDARIO -->
                <div class="mb-2">
                    <SchoolSystem.Web.Shared.Components.HorizontalCalendar @bind-SelectedDate="fechaSeleccionadaDashboard" />
                </div>
                <div class="text-center mb-6">
                    <MudText Typo="Typo.caption" Class="text-muted">
                        Eventos del: <strong>@fechaSeleccionadaDashboard.ToShortDateString()</strong>
                    </MudText>
                </div>
                <MudDivider Class="my-6" />
                <!-- HOLIDAY LISTS -->
                <SchoolSystem.Web.Shared.Components.HolidayList />
                <MudDivider Class="my-6" />
                <!-- NOTICE BOARD -->
                <div>
                    <MudText Typo="Typo.subtitle2" Class="fw-bold mb-4">Notice Board</MudText>
                    <div class="d-flex flex-column gap-4">
                        <div class="d-flex gap-3">
                            <MudAvatar Rounded="true" Color="Color.Primary" Size="Size.Medium">EL</MudAvatar>
                            <div>
                                <MudText Typo="Typo.body2" Class="fw-bold" Style="line-height: 1.2;">School year start</MudText>
                                <MudText Typo="Typo.caption" Class="text-muted">By Erwin Legros</MudText>
                            </div>
                        </div>
                        <div class="d-flex gap-3">
                            <MudAvatar Rounded="true" Color="Color.Secondary" Size="Size.Medium">AB</MudAvatar>
                            <div>
                                <MudText Typo="Typo.body2" Class="fw-bold" Style="line-height: 1.2;">Inspirational quotes</MudText>
                                <MudText Typo="Typo.caption" Class="text-muted">By Ardith Bode</MudText>
                            </div>
                        </div>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

<style>
    /* Diseño Mobile First: Una sola columna */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px; /* Spacing */
    }
    </style>
@code {
    // ... El bloque @code permanece IGUAL que antes ...
    private DashboardDto stats;
    private bool isLoading = true;
    private string userName;
    private DateTime fechaSeleccionadaDashboard = DateTime.Today;

    public List<ChartSeries> SeriesStudents = new();
    public string[] LabelsAnios;

    // Configuración visual
    private ChartOptions OptionsAlumnos = new ChartOptions
    {
        ChartPalette = new[] { "#3B82F6", "#10B981", "#EF4444" }, // Azul, Verde, Rojo
        YAxisLines = true
    };

    // --- GRÁFICA FINANZAS (Stacked) ---
    public List<ChartSeries> SeriesFinanzas = new();
    public string[] LabelsMesesFinanzas;
    public double TendenciaFinanciera = 0;

    private ChartOptions OptionsFinanzas = new ChartOptions
    {
        ChartPalette = new[] { "#10B981", "#E2E8F0" }, // Verde (Cobrado), Gris (Pendiente)
        YAxisLines = false
    };


    public double[] dataActivities = { 65, 35 };
    public string[] labelsActivities = { "Process", "In Process" };
    
    class EstudianteDummy { public string Nombre {get;set;} public string Matricula {get;set;} public string Grado {get;set;} }
    List<EstudianteDummy> estudiantesDummy = new List<EstudianteDummy>
    {
        new EstudianteDummy { Nombre = "Ana García", Matricula = "A2024001", Grado = "3° A" },
        new EstudianteDummy { Nombre = "Luis Rodriguez", Matricula = "A2024055", Grado = "1° B" },
        new EstudianteDummy { Nombre = "Sofia Martinez", Matricula = "A2024012", Grado = "5° C" },
        new EstudianteDummy { Nombre = "Carlos Lopez", Matricula = "A2024089", Grado = "2° A" },
        new EstudianteDummy { Nombre = "Elena Torres", Matricula = "A2024033", Grado = "6° B" },
    };

    private List<ChartSeries> ConvertirSeries(List<ChartSeriesDto> dtos)
    {
        return dtos.Select(s => new ChartSeries
        {
            Name = s.Name,
            Data = s.Data
        }).ToList();
    }


    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = state.User.Identity?.Name ?? "Usuario";
        try
        {
            var res = await DashboardService.GetStatsAsync();
            if (res.Succeeded)
            {
                stats = res.Data;

                // 1. Mapear Gráfica Alumnos
                if (stats.StudentsChart != null)
                {
                    LabelsAnios = stats.StudentsChart.Labels.ToArray();
                    SeriesStudents = ConvertirSeries(stats.StudentsChart.Series);
                }

                // 2. Mapear Gráfica Finanzas
                if (stats.FinanceChart != null)
                {
                    LabelsMesesFinanzas = stats.FinanceChart.Labels.ToArray();

                    // Convertimos la serie simple a Stacked (Cobrado vs Pendiente)
                    // Para este ejemplo visual, simularemos la "Pendiente" como un 20% del total
                    // En producción, tu API debería devolver ambas series.

                    var dataCobrado = stats.FinanceChart.Series[0].Data;
                    var dataPendiente = dataCobrado.Select(d => d * 0.2).ToArray(); // Simulación

                    SeriesFinanzas.Add(new ChartSeries { Name = "Cobrado", Data = dataCobrado });
                    SeriesFinanzas.Add(new ChartSeries { Name = "Por Cobrar", Data = dataPendiente });

                    // Calcular Tendencia (Mes actual vs Anterior)
                    if (dataCobrado.Length >= 2)
                    {
                        var actual = dataCobrado.Last();
                        var anterior = dataCobrado[dataCobrado.Length - 2];
                        if (anterior > 0)
                            TendenciaFinanciera = ((actual - anterior) / anterior) * 100;
                    }
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }
}