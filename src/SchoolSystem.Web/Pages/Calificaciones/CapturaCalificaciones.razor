@page "/calificaciones/captura"
@using MudBlazor
@using SchoolSystem.Web.Models
@using SchoolSystem.Web.Services
@using SchoolSystem.Web.Services.Toast
@using SchoolSystem.Web.Shared.Components.Calificaciones
@inject PeriodoEvaluacionService PeriodoEvaluacionService
@inject ToastService ToastService
@inject CalificacionService CalificacionService
@inject InscripcionService InscripcionService
@inject CurrentUserContextService CurrentUserContextService
@inject GrupoService GrupoService
@inject MateriaService MateriaService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@attribute [Authorize]

<PageTitle>Captura de Calificaciones</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="oi oi-pencil"></i> Captura de Calificaciones</h2>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Selección de Grupo y Materia</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@modelo" OnValidSubmit="CargarAlumnos">
                <DataAnnotationsValidator />

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Grupo</label>
                        <InputSelect class="form-select"
                                     TValue="int"
                                     @bind-Value="modelo.GrupoId"
                                     @bind-Value:after="OnGrupoChangedAfter">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var g in grupos)
                            {
                                <option value="@g.Id">@g.NombreCompleto</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Materia</label>
                        <InputSelect class="form-select"
                                     TValue="int"
                                     @bind-Value="modelo.MateriaId"
                                     disabled="@(modelo.GrupoId == 0 || isLoadingCatalogs)">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var m in materias)
                            {
                                <option value="@m.Id">@m.Nombre</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Periodo</label>
                        <InputSelect class="form-select"
                                     TValue="int"
                                     @bind-Value="modelo.PeriodoId"
                                     disabled="@(modelo.GrupoId == 0 || isLoadingCatalogs || !periodos.Any())">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var p in periodos.OrderBy(x => x.Numero))
                            {
                                <option value="@p.Id">@p.Nombre</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" disabled="@(isLoading || isLoadingCatalogs)">
                            @if (isLoadingCatalogs)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span><span>Cargando datos...</span>
                            }
                            else if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span><span>Buscando...</span>
                            }
                            else
                            {
                                <span><i class="oi oi-magnifying-glass"></i> Cargar Alumnos</span>
                            }
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    @if (modelo.Calificaciones != null && modelo.Calificaciones.Any())
    {
        <!-- PASO 2: Mostrar resumen del precheck -->
        @if (_precheck != null)
        {
            <MudPaper Class="pa-4 mb-4 bg-light">
                <MudStack Spacing="2">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <MudText Typo="Typo.caption" Color="Color.Tertiary">Total Enviados</MudText>
                                <MudText Typo="Typo.h5">@_total</MudText>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <MudText Typo="Typo.caption" Color="Color.Info">Ya Existentes</MudText>
                                <MudText Typo="Typo.h5" Color="Color.Info">@_existentes</MudText>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <MudText Typo="Typo.caption" Color="Color.Success">Nuevas</MudText>
                                <MudText Typo="Typo.h5" Color="Color.Success">@_nuevas</MudText>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <MudText Typo="Typo.caption" Color="Color.Error">Errores</MudText>
                                <MudText Typo="Typo.h5" Color="Color.Error">@_precheck.TotalErrores</MudText>
                            </div>
                        </div>
                    </div>

                    @if (!_precheck.PermiteRecalificar && _existentes > 0)
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Warning">
                            <MudText Typo="Typo.body2">
                                <strong>⚠️ No se puede recalificar:</strong> @_precheck.MotivoNoPermiteRecalificar
                            </MudText>
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>
        }

        <!-- PASO 4: Resumen mejorado de Totales/Pendientes/YaCalificados -->
        <MudPaper Class="pa-3 mb-3">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2">
                    <strong>Resumen:</strong>
                </MudText>
                <MudChip T="string" Color="Color.Default" Icon="@Icons.Material.Filled.Info" Size="Size.Small">
                    Total: @_totalAlumnos
                </MudChip>
                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small">
                    Pendientes: @_alumnosPendientes
                </MudChip>
                <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.HourglassBottom" Size="Size.Small">
                    Ya Calificados: @_alumnosYaCalificados
                </MudChip>
                <MudSpacer />
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.body2">
                        Mostrar solo pendientes:
                    </MudText>
                    <MudSwitch T="bool" @bind-Checked="@_soloPendientes" Color="Color.Primary" />
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- PASO 4: Alert si se detectaron nuevos existentes por concurrencia -->
        @if (_mostrarAlertaConcurrencia)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mb-3" Icon="@Icons.Material.Filled.Warning">
                <MudText Typo="Typo.body2">
                    <strong>⚠️ Concurrencia detectada:</strong> Se detectaron nuevas calificaciones existentes (posiblemente otro usuario capturó en el mismo período). Se marcaron en amarillo.
                </MudText>
            </MudAlert>
        }

        <!-- PASO 5: Alert si hay conflicto al guardar (409) -->
        @if (_mostrarAlertaConflictoGuardado)
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mb-3" Icon="@Icons.Material.Filled.Error">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2">
                        <strong>❌ Conflicto detectado:</strong> Otro usuario capturó calificaciones simultáneamente. Se actualizó la lista de alumnos con calificaciones existentes.
                    </MudText>
                    <MudText Typo="Typo.caption">
                        Revisa los cambios y reintenta si es necesario. Si el conflicto persiste, recarga la página.
                    </MudText>
                </MudStack>
            </MudAlert>
        }

        <!-- PASO 14: Mostrar alertas de errores críticos -->
        @if (modelo.Calificaciones.Any(c => c.EstadoPreview == "Error"))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mb-3" Icon="@Icons.Material.Filled.Error">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2">
                        <strong>⚠️ Errores en captura:</strong> Los siguientes alumnos no pueden ser procesados. Revisa y contacta al administrador si es necesario.
                    </MudText>
                    <MudText Typo="Typo.caption">
                        Total: <strong>@modelo.Calificaciones.Count(c => c.EstadoPreview == "Error")</strong> alumno(s) con problemas.
                    </MudText>
                </MudStack>
            </MudAlert>
        }

        <div class="card shadow border-0">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-primary mb-0">Listado de Alumnos</h5>
                    <span class="badge bg-info text-dark">@(_soloPendientes ? _alumnosPendientes : modelo.Calificaciones.Count) alumnos mostrados</span>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 15%">Matrícula</th>
                                <th style="width: 25%">Nombre del Alumno</th>
                                <th style="width: 15%" class="text-center">Estado</th>
                                <th style="width: 15%" class="text-center">Calificación</th>
                                <th style="width: 30%">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in GetItemsAMostrar())
                            {
                                <tr class="@(item.EstadoPreview == "Error" ? "table-danger" : item.YaTieneCalificacion && _mostrarAlertaConcurrencia ? "table-warning" : "")">
                                    <td>@item.Matricula</td>
                                    <td class="fw-bold">@item.NombreAlumno</td>

                                    <!-- PASO 14: Estado basado en preview -->
                                    <td class="text-center">
                                        @switch (item.EstadoPreview)
                                        {
                                            case "Insertar":
                                                <MudTooltip Text="Nueva calificación">
                                                    <MudChip T="string" Color="Color.Success" Variant="Variant.Outlined" Size="Size.Small">
                                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="me-1"></MudIcon>
                                                        Nueva
                                                    </MudChip>
                                                </MudTooltip>
                                                break;

                                            case "Actualizar":
                                                <MudTooltip Text="Será recalificada">
                                                    <MudChip T="string" Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Small">
                                                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="me-1"></MudIcon>
                                                        Actualizar
                                                    </MudChip>
                                                </MudTooltip>
                                                break;

                                            case "OmitirExistente":
                                                <MudTooltip Text="@item.MotivoPreview">
                                                    <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small">
                                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="me-1"></MudIcon>
                                                        Existente
                                                    </MudChip>
                                                </MudTooltip>
                                                break;

                                            case "Error":
                                                <MudTooltip Text="@item.MotivoPreview">
                                                    <MudChip T="string" Color="Color.Error" Variant="Variant.Outlined" Size="Size.Small">
                                                        <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Class="me-1"></MudIcon>
                                                        Error
                                                    </MudChip>
                                                </MudTooltip>
                                                break;

                                            default:
                                                <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">
                                                    Pendiente
                                                </MudChip>
                                                break;
                                        }
                                    </td>

                                    <!-- CALIFICACIÓN -->
                                    <td>
                                        <input type="number"
                                               class="form-control text-center fw-bold @GetClaseCalificacion(item.CalificacionNumerica)"
                                               @bind="item.CalificacionNumerica"
                                               min="0" max="10" step="0.1"
                                               disabled="@(!item.HabilitadoParaEdicion || item.EstadoPreview == "Error")" />
                                    </td>

                                    <!-- OBSERVACIONES -->
                                    <td>
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               @bind="item.Observaciones"
                                               placeholder="Opcional..."
                                               disabled="@(!item.HabilitadoParaEdicion || item.EstadoPreview == "Error")" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-light py-3 text-end">
                <button class="btn btn-success px-4" 
                        @onclick="GuardarCalificaciones" 
                        disabled="@IsGuardarDisabled()">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span> <span>Guardando...</span>
                    }
                    else if (modelo.Calificaciones.Any(c => c.EstadoPreview == "Error"))
                    {
                        <span><i class="oi oi-block"></i> No se puede guardar (hay errores)</span>
                    }
                    else if (!_precheckOk)
                    {
                        <span><i class="oi oi-block"></i> Carga alumnos primero</span>
                    }
                    else
                    {
                        <span><i class="oi oi-check"></i> Guardar Calificaciones</span>
                    }
                </button>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Buscando alumnos...</p>
        </div>
    }
    else if (busquedaRealizada)
    {
        <div class="alert alert-warning text-center mt-4 shadow-sm">
            <i class="oi oi-warning me-2"></i> No se encontraron alumnos inscritos en este grupo para la materia seleccionada.
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
</div>

@code {
    [SupplyParameterFromQuery] public int? GrupoId { get; set; }

    private List<PeriodoEvaluacionDto> periodos = new();
    private CreateCalificacionMasivaDto modelo = new();
    private List<GrupoDto> grupos = new();
    private List<MateriaDto> materias = new();

    private bool isLoading;
    private bool isLoadingCatalogs = true;
    private bool isSaving;
    private bool busquedaRealizada;
    private string? errorMessage;

    // PASO 2: Estado local para guardar el precheck
    private CalificacionMasivaResultadoDto? _precheck;
    private bool _precheckOk;

    // PASO 2: Helpers computed properties
    private int _total => _precheck?.TotalEnviadas ?? 0;
    private int _existentes => _precheck?.Existentes?.Count ?? 0;
    private int _nuevas => Math.Max(0, _total - _existentes);

    // PASO 4: UX mejorada
    private bool _soloPendientes = false;
    private bool _mostrarAlertaConcurrencia = false;
    private bool _mostrarAlertaConflictoGuardado = false;

    // PASO 4: Propiedades computed para resumen
    private int _totalAlumnos => modelo.Calificaciones?.Count ?? 0;
    private int _alumnosPendientes => modelo.Calificaciones?.Count(x => !x.YaTieneCalificacion) ?? 0;
    private int _alumnosYaCalificados => modelo.Calificaciones?.Count(x => x.YaTieneCalificacion) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        isLoadingCatalogs = true;
        try
        {
            var t1 = GrupoService.GetGruposAsync(1, 100);
            var t2 = MateriaService.GetAsync(1, 100);

            await Task.WhenAll(t1, t2);

            var r1 = await t1;
            var r2 = await t2;

            if (r1.Succeeded) grupos = r1.Data.Items.ToList();
            if (r2.Succeeded) materias = r2.Data.Items.ToList();

            if (GrupoId.HasValue && GrupoId.Value > 0)
                modelo.GrupoId = GrupoId.Value;
        }
        catch (Exception ex)
        {
            errorMessage = "Error cargando catálogos: " + ex.Message;
        }
        finally
        {
            isLoadingCatalogs = false;
        }
    }

    private async Task CargarAlumnos()
    {
        if (isLoading) return;

        if (modelo.GrupoId == 0 || modelo.MateriaId == 0 || modelo.PeriodoId == 0)
        {
            errorMessage = "Seleccione Grupo, Materia y Periodo.";
            return;
        }

        isLoading = true;
        busquedaRealizada = false;
        errorMessage = null;

        modelo.Calificaciones ??= new List<CalificacionAlumnoDto>();
        modelo.Calificaciones.Clear();

        try
        {
            var ins = await InscripcionService.GetAlumnosPorGrupoAsync(modelo.GrupoId, soloActivos: true);

            if (!ins.Succeeded || ins.Data == null)
            {
                ToastService.ShowError(ins.Message ?? "No se pudo cargar la lista de alumnos.");
                return;
            }

            foreach (var a in ins.Data)
            {
                modelo.Calificaciones.Add(new CalificacionAlumnoDto
                {
                    AlumnoId = a.AlumnoId,
                    NombreAlumno = a.NombreCompletoAlumno,
                    Matricula = a.Matricula,
                    CalificacionNumerica = 0,
                    Observaciones = "",
                    HabilitadoParaEdicion = true
                });
            }

            if (!modelo.Calificaciones.Any())
            {
                ToastService.ShowWarning("No se encontraron alumnos inscritos en este grupo.");
                return;
            }

            // --- Precheck "enterprise": marcar existentes y bloquear edición para esos ---
            await AplicarPrecheckExistentesAsync(mostrarToast: true);

            // IMPORTANTE: nunca dejes el modelo en SoloValidar para la UI
            modelo.SoloValidar = false;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            ToastService.ShowError("Error al cargar alumnos: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            busquedaRealizada = true;
        }
    }

    private async Task AplicarPrecheckExistentesAsync(bool mostrarToast)
    {
        var ctx = await CurrentUserContextService.GetAsync();
        modelo.CapturadoPor = ctx.UserId;
        modelo.EscuelaId = ctx.EscuelaId;

        modelo.SoloValidar = true;
        modelo.PermitirRecalificarExistentes = false;

        var pre = await CalificacionService.CreateMasivoAsync(modelo);

        // PASO 2: Guardar el precheck en estado local
        _precheck = pre.Data;
        _precheckOk = pre.Succeeded;

        if (pre.Succeeded && pre.Data != null)
        {
            var previewMap = pre.Data.PreviewPorAlumno?.ToDictionary(x => x.AlumnoId) ?? new();

            foreach (var item in modelo.Calificaciones)
            {
                if (previewMap.TryGetValue(item.AlumnoId, out var preview))
                {
                    item.EstadoPreview = preview.Estado;
                    item.MotivoPreview = preview.Motivo;

                    if (preview.CalificacionActual.HasValue)
                    {
                        item.YaTieneCalificacion = true;
                        item.CalificacionActual = preview.CalificacionActual;
                        item.ObservacionesActuales = preview.ObservacionesActuales;
                        item.HabilitadoParaEdicion = false;
                    }
                    else
                    {
                        item.YaTieneCalificacion = false;
                        item.CalificacionActual = null;
                        item.ObservacionesActuales = null;
                        item.HabilitadoParaEdicion = preview.Estado != "Error";
                    }
                }
                else
                {
                    item.EstadoPreview = "Pendiente";
                    item.MotivoPreview = null;
                    item.YaTieneCalificacion = false;
                    item.CalificacionActual = null;
                    item.ObservacionesActuales = null;
                    item.HabilitadoParaEdicion = true;
                }
            }

            if (mostrarToast && (pre.Data.TotalActualizarias > 0 || pre.Data.TotalErrores > 0))
            {
                if (pre.Data.TotalErrores > 0)
                    ToastService.ShowError($"{pre.Data.TotalErrores} alumno(s) con problemas. {pre.Data.TotalActualizarias} para recalificar.");
                else if (pre.Data.TotalActualizarias > 0)
                    ToastService.ShowWarning($"{pre.Data.TotalActualizarias} alumno(s) ya tienen calificaciones.");
            }
        }
        else
        {
            foreach (var item in modelo.Calificaciones)
            {
                item.EstadoPreview = "Pendiente";
                item.MotivoPreview = null;
                item.YaTieneCalificacion = false;
                item.CalificacionActual = null;
                item.ObservacionesActuales = null;
                item.HabilitadoParaEdicion = true;
            }
        }

        modelo.SoloValidar = false;
    }

    // PASO 2: Helper para controlar si Guardar está deshabilitado
    private bool IsGuardarDisabled()
    {
        if (isSaving || isLoading)
            return true;

        if (modelo.Calificaciones == null || !modelo.Calificaciones.Any())
            return true;

        if (!_precheckOk)
            return true;

        if (modelo.Calificaciones.Any(c => c.EstadoPreview == "Error"))
            return true;

        return false;
    }

    private async Task GuardarCalificaciones()
    {
        // PASO 3: Validaciones iniciales
        if (modelo.Calificaciones == null || !modelo.Calificaciones.Any())
        {
            ToastService.ShowWarning("No hay alumnos cargados para guardar calificaciones.");
            return;
        }

        // PASO 5: Guard clause para evitar doble submit
        if (isSaving) 
        {
            ToastService.ShowInfo("La solicitud ya está en proceso. Por favor, espera...");
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            // PASO 3: Obtener contexto real
            var ctx = await CurrentUserContextService.GetAsync();
            modelo.CapturadoPor = ctx.UserId;
            modelo.EscuelaId = ctx.EscuelaId;

            // PASO 3: PRECHECK fresco antes de guardar
            modelo.SoloValidar = true;
            modelo.PermitirRecalificarExistentes = false;

            var pre = await CalificacionService.CreateMasivoAsync(modelo);

            if (!pre.Succeeded)
            {
                ToastService.ShowError(pre.Message ?? "No se pudo validar.");
                return;
            }

            // Actualizar precheck local con resultado fresco
            _precheck = pre.Data;
            _precheckOk = pre.Succeeded;

            var preData = pre.Data;
            bool permitirRecalificar = false;

            // PASO 3: Si hay existentes, mostrar dialog
            if (preData?.Existentes?.Any() == true)
            {
                // Actualizar flags visuales con el precheck fresco
                var previewMap = preData.PreviewPorAlumno?.ToDictionary(x => x.AlumnoId) ?? new();
                foreach (var item in modelo.Calificaciones)
                {
                    if (previewMap.TryGetValue(item.AlumnoId, out var preview))
                    {
                        item.EstadoPreview = preview.Estado;
                        item.MotivoPreview = preview.Motivo;
                    }
                }

                // Abrir dialog RecalificarExistentesDialog
                var parameters = new DialogParameters { ["Model"] = preData };
                var options = new DialogOptions
                {
                    CloseOnEscapeKey = true,
                    MaxWidth = MaxWidth.Medium,
                    FullWidth = true
                };

                var dialog = DialogService.Show<RecalificarExistentesDialog>("Confirmación", parameters, options);
                var result = await dialog.Result;

                if (result.Canceled)
                {
                    modelo.SoloValidar = false;
                    ToastService.ShowInfo("Operación cancelada por el usuario.");
                    return;
                }

                    var decision = result.Data as RecalificarDecision;
                    permitirRecalificar = decision?.PermitirRecalificarExistentes ?? false;

                    // AUDITORÍA: Capturar motivo de recalificación
                    if (permitirRecalificar)
                    {
                        modelo.MotivoRecalificacion = decision?.MotivoRecalificacion;

                        // Validación adicional: si viene vacío, rechazar
                        if (string.IsNullOrWhiteSpace(modelo.MotivoRecalificacion))
                        {
                            ToastService.ShowError("El motivo de recalificación es requerido.");
                            permitirRecalificar = false;
                        }
                        else
                        {
                            // AUDITORÍA: Propagar motivo a cada alumno que será recalificado
                            // Esto se enviará al backend en el modelo.Calificaciones
                            foreach (var item in modelo.Calificaciones)
                            {
                                if (item.YaTieneCalificacion)
                                {
                                    item.MotivoModificacion = modelo.MotivoRecalificacion;
                                }
                            }
                        }
                    }

                    // Validación: si usuario quiere recalificar pero el período no lo permite
                    if (permitirRecalificar && !preData.PermiteRecalificar)
                    {
                        ToastService.ShowError($"No se puede recalificar: {preData.MotivoNoPermiteRecalificar}");
                        permitirRecalificar = false;
                    }

                    // Si se recalificará, habilitar edición solo para existentes
                    if (permitirRecalificar)
                    {
                        var idsExistentes = preData.Existentes.Select(x => x.AlumnoId).ToHashSet();
                        foreach (var item in modelo.Calificaciones)
                            item.HabilitadoParaEdicion = idsExistentes.Contains(item.AlumnoId) || !item.YaTieneCalificacion;
                    }
                }

                // PASO 3: COMMIT real
                modelo.SoloValidar = false;
                modelo.PermitirRecalificarExistentes = permitirRecalificar;

            var resp = await CalificacionService.CreateMasivoAsync(modelo);

            if (resp.Succeeded)
            {
                // FEEDBACK: Mostrar resumen completo
                var tieneErrores = resp.Data.Errores?.Any() == true;

                var mensaje = $"✅ Operación completada:\n" +
                    $"• Nuevas: {resp.Data.Insertadas}\n" +
                    $"• Recalificadas: {resp.Data.Actualizadas}";

                if (tieneErrores)
                {
                    mensaje += $"\n• ⚠️ Errores: {resp.Data.Errores.Count}";
                    ToastService.ShowWarning(mensaje);

                    // NO navegar si hay errores: dejar que el usuario vea y corrija
                    ToastService.ShowInfo("No navegamos automáticamente. Revisa los errores y reintenta si es necesario.");
                }
                else
                {
                    ToastService.ShowSuccess(mensaje);

                    // Navegar después de 1.5 segundos para que el usuario vea el toast
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/calificaciones");
                }
            }
            else
            {
                // PASO 4: Mejorar manejo de concurrencia
                await ManejarRespuestaGuardado(resp);
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            ToastService.ShowError("Error al guardar: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            modelo.SoloValidar = false; // Asegurar que queda en false
        }
    }

    private string GetClaseCalificacion(decimal calificacion)
    {
        if (calificacion < 6) return "text-danger";
        if (calificacion >= 9) return "text-success";
        return "";
    }

    private async Task OnGrupoChanged(int value)
    {
        modelo.GrupoId = value;

        modelo.PeriodoId = 0;
        periodos.Clear();
        modelo.Calificaciones?.Clear();
        busquedaRealizada = false;
        errorMessage = null;

        // PASO 2: Limpiar precheck cuando cambia Grupo
        _precheck = null;
        _precheckOk = false;

        // PASO 4: Limpiar alertas cuando cambia Grupo
        _mostrarAlertaConcurrencia = false;
        _soloPendientes = false;

        // PASO 5: Limpiar alert de conflicto cuando cambia Grupo
        _mostrarAlertaConflictoGuardado = false;

        if (modelo.GrupoId <= 0)
            return;

        var resp = await PeriodoEvaluacionService.GetPorGrupoAsync(modelo.GrupoId, soloActivos: true);
        if (resp.Succeeded && resp.Data != null)
            periodos = resp.Data;
        else
            ToastService.ShowError(resp.Message ?? "No se pudieron cargar los periodos.");
    }

        private async Task OnGrupoChangedAfter() => await OnGrupoChanged(modelo.GrupoId);

        // PASO 4: Método helper para filtrar items según toggle
        private IEnumerable<CalificacionAlumnoDto> GetItemsAMostrar()
        {
            if (modelo.Calificaciones == null)
                return Enumerable.Empty<CalificacionAlumnoDto>();

            return _soloPendientes
                ? modelo.Calificaciones.Where(x => !x.YaTieneCalificacion)
                : modelo.Calificaciones;
        }

            // PASO 5: Mejorar manejo de 409 Conflict en GuardarCalificaciones
            private async Task ManejarRespuestaGuardado(ApiResponse<CalificacionMasivaResultadoDto> resp)
            {
                if (!resp.Succeeded)
                {
                    // AUDITORÍA: Detectar error por motivo requerido
                    var esErrorMotivo = resp.Message != null && 
                        resp.Message.Contains("motivo", StringComparison.OrdinalIgnoreCase);

                    if (esErrorMotivo)
                    {
                        ToastService.ShowError("❌ El motivo de recalificación es requerido. Abre el diálogo nuevamente e indica un motivo.");
                        return;
                    }

                    // PASO 5: Detectar error por concurrencia/duplicados (409 Conflict o heurística)
                    // Detecta: "Conflicto", "ya fueron capturadas", "duplicate", "unique", "concurrencia"
                    var esConflictoConcurrencia = resp.Message != null && 
                        (resp.Message.Contains("Conflicto", StringComparison.OrdinalIgnoreCase) ||
                         resp.Message.Contains("ya fueron capturadas", StringComparison.OrdinalIgnoreCase) ||
                         resp.Message.Contains("duplicate", StringComparison.OrdinalIgnoreCase) ||
                         resp.Message.Contains("unique", StringComparison.OrdinalIgnoreCase) ||
                         resp.Message.Contains("concurrencia", StringComparison.OrdinalIgnoreCase));

                    if (esConflictoConcurrencia)
                    {
                        ToastService.ShowWarning("⚠️ Otro usuario ya capturó algunas calificaciones. Actualizando lista…");

                        // Ejecutar precheck fresco automáticamente
                        await AplicarPrecheckExistentesAsync(mostrarToast: false);

                        // Mostrar alert de conflicto permanente
                        _mostrarAlertaConflictoGuardado = true;

                        // Mostrar feedback adicional
                        ToastService.ShowInfo("Se actualizó la lista. Revisa los cambios y reintenta si es necesario.");

                        return;
                    }

                    ToastService.ShowError(resp.Message ?? "No se pudo guardar.");
                }
            }
        }
