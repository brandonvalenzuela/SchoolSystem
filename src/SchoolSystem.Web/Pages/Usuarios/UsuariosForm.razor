@page "/usuarios/crear"
@page "/usuarios/editar/{Id:int}"
@using SchoolSystem.Web.Models
@using SchoolSystem.Web.Services
@inject UsuarioService UsuarioService
@inject UiService UiService
@inject NavigationManager Navigation
@attribute [Authorize]

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
            <h3>@(Id == 0 ? "Nuevo Usuario Administrativo" : "Editar Usuario")</h3>
            <a href="usuarios" class="btn btn-light btn-sm">Volver</a>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <p>Cargando...</p>
            }
            else
            {
                <EditForm Model="@modelo" OnValidSubmit="Guardar">
                    <DataAnnotationsValidator />
                    <div class="alert alert-info">
                        <small>Nota: Use este formulario solo para Directores y Administrativos. Para Maestros, Padres o Alumnos vaya a sus módulos respectivos.</small>
                    </div>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nombre</label>
                            <InputText class="form-control" @bind-Value="modelo.Nombre" />
                            <ValidationMessage For="@(() => modelo.Nombre)" />
                        </div>
                        <div class="col-md-6">
                            <label>Apellido Paterno</label>
                            <InputText class="form-control" @bind-Value="modelo.ApellidoPaterno" />
                            <ValidationMessage For="@(() => modelo.ApellidoPaterno)" />
                        </div>
                        <div class="col-md-6">
                            <label>Apellido Materno</label>
                            <InputText class="form-control" @bind-Value="modelo.ApellidoMaterno" />
                        </div>
                        <div class="col-md-6">
                            <label>Rol</label>
                            <!-- Solo permitimos roles administrativos aquí -->
                            <InputSelect class="form-select" @bind-Value="modelo.Rol">
                                <option value="2">Director</option>
                                <option value="3">Subdirector</option>
                                <option value="4">Administrativo</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6">
                            <label>Email</label>
                            <InputText class="form-control" @bind-Value="modelo.Email" />
                            <ValidationMessage For="@(() => modelo.Email)" />
                        </div>
                        <div class="col-md-6">
                            <label>Username</label>
                            <InputText class="form-control" @bind-Value="modelo.Username" />
                            <ValidationMessage For="@(() => modelo.Username)" />
                        </div>
                        @if (Id == 0)
                        {
                            <div class="col-md-6">
                                <label>Contraseña</label>
                                <InputText type="password" class="form-control" @bind-Value="modelo.Password" />
                                <ValidationMessage For="@(() => modelo.Password)" />
                            </div>
                        }
                    </div>

                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-success" disabled="@isSubmitting">Guardar</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private CreateUsuarioDto modelo = new CreateUsuarioDto { Rol = 4 }; // Default Administrativo
    private bool isLoading = false, isSubmitting = false;
    private string errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {
            isLoading = true;
            var response = await UsuarioService.GetByIdAsync(Id);
            if (response.Succeeded)
            {
                var u = response.Data;
                modelo.Nombre = u.Nombre;
                modelo.ApellidoPaterno = u.ApellidoPaterno;
                modelo.ApellidoMaterno = u.ApellidoMaterno;
                modelo.Email = u.Email;
                modelo.Username = u.Username;
                modelo.Telefono = u.Telefono;
                // Mapear rol string a int es tedioso, simplificamos asumiendo Administrativo para demo
                // modelo.Rol = ...
                modelo.Password = "PLACEHOLDER";
            }
            isLoading = false;
        }
    }

    private async Task Guardar()
    {
        isSubmitting = true;
        // Lógica de Create / Update similar a la de Alumnos
        // ... (Implementa la llamada al servicio aquí) ...
        try
        {
            if (Id == 0)
            {
                var res = await UsuarioService.CreateAsync(modelo);
                if (res.Succeeded)
                { UiService.ShowSuccess("Usuario creado."); Navigation.NavigateTo("usuarios"); }
                else
                    errorMessage = res.Message;
            }
            else
            {
                // Mapear a UpdateDto y llamar UpdateAsync
                // Recuerda manejar el mapeo de Rol correctamente
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
        isSubmitting = false;
    }
}