@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Authorization

@if (noTienePermisos)
{
    <div class="container mt-5">
        <div class="alert alert-danger text-center shadow">
            <h4 class="alert-heading">🚫 Acceso Denegado</h4>
            <p>No tienes los permisos suficientes para ver esta sección.</p>
            <hr>
            <button class="btn btn-outline-danger" @onclick="IrAlInicio">Volver al Inicio</button>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; } // Nota el ? para nullable

    private bool noTienePermisos = false;

    protected override async Task OnInitializedAsync()
    {
        // 1. Verificación de seguridad por si el CascadingParameter falla
        if (AuthStateTask == null)
        {
            // Si es nulo, algo falló en la configuración de seguridad.
            // Por seguridad, mandamos al login.
            Navigation.NavigateTo("login");
            return;
        }

        // 2. Ahora es seguro hacer el await
        var authState = await AuthStateTask;
        var user = authState.User;

        // 3. Verificamos si está logueado
        if (user.Identity == null || !user.Identity.IsAuthenticated)
        {
            // --- LÓGICA DE RETORNO (ReturnUrl) ---
            // Capturamos la URL actual para regresar aquí después del login
            var returnUrl = Uri.EscapeDataString(Navigation.Uri);

            // Redirigimos
            Navigation.NavigateTo($"login?returnUrl={returnUrl}");
        }
        else
        {
            // 4. Si llegó aquí estando logueado, es porque el Router lo rebotó (Falta de Rol)
            noTienePermisos = true;
        }
    }

    private void IrAlInicio()
    {
        Navigation.NavigateTo("/");
    }
}