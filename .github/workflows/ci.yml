name: CI Pipeline - SchoolSystem

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: 8.0.x
  CONFIGURATION: Release
  SOLUTION_PATH: ./SchoolSystem.sln

jobs:
  build-and-test:
    name: Build & Test (.NET 8 / .NET 10)
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: SchoolSystem
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      # 1. Checkout del código
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history para cálculos de versión

      # 2. Setup .NET
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # 3. Restore NuGet packages
      - name: Restore NuGet Packages
        run: dotnet restore ${{ env.SOLUTION_PATH }}
        env:
          NUGET_XMLDOC_MODE: skip

      # 4. Build solution
      - name: Build Solution
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.CONFIGURATION }} --no-restore
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: true

      # 5. Esperar a que MySQL esté listo
      - name: Wait for MySQL
        run: |
          until mysql -h 127.0.0.1 -u root -proot -e "SELECT 1" > /dev/null 2>&1; do
            echo "Esperando MySQL..."
            sleep 1
          done
        shell: bash

      # 6. Crear BD de test (si se requiere migración manual)
      - name: Create Test Database
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE IF NOT EXISTS SchoolSystem_Test;"
        shell: bash

      # 7. Run Unit Tests
      - name: Run Unit Tests
        run: |
          dotnet test tests/SchoolSystem.UnitTests/SchoolSystem.UnitTests.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --logger trx \
            --results-directory ./test-results
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          DOTNET_CLI_TELEMETRY_OPTOUT: true

      # 8. Run Functional Tests
      - name: Run Functional Tests
        run: |
          dotnet test tests/SchoolSystem.FunctionalTests/SchoolSystem.FunctionalTests.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --logger trx \
            --results-directory ./test-results
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          DOTNET_CLI_TELEMETRY_OPTOUT: true
        continue-on-error: true  # No bloquear si estos fallan

      # 9. Run Integration Tests (PASO 6A)
      - name: Run Integration Tests (PASO 6A - Calificaciones Masivo)
        run: |
          dotnet test tests/SchoolSystem.IntegrationTests/SchoolSystem.IntegrationTests.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --logger trx \
            --results-directory ./test-results \
            --filter "FullyQualifiedName~CalificacionesMasivoIntegrationTests" \
            -v detailed
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=SchoolSystem_Test;Uid=root;Pwd=root;"
          DOTNET_CLI_TELEMETRY_OPTOUT: true
        continue-on-error: true  # No bloquear si hay tests con Skip

      # 10. Publicar resultados de tests
      - name: Publish Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.dotnet-version }}
          path: ./test-results/
          retention-days: 30

      # 11. Fallar pipeline si Unit Tests falla
      - name: Fail on Unit Test Failure
        if: failure()
        run: |
          echo "::error::Unit Tests failed. Please review the errors above."
          exit 1

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # SonarQube Analysis (Opcional - comentar si no se usa)
      # - name: SonarCloud Scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONARCLOUD_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}

      - name: Restore Packages
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.CONFIGURATION }} --no-restore

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Dependabot (nativo de GitHub)
      - name: Check for Dependency Vulnerabilities
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [ build-and-test, code-quality ]
    if: always()

    steps:
      - name: CI Status Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test Results: Available in build artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Required Jobs Failed
        if: |
          needs.build-and-test.result == 'failure'
        run: |
          echo "::error::CI Pipeline failed. Required checks did not pass."
          exit 1
